[1mdiff --cc database.js[m
[1mindex 5eade0e,b81a8d3..0000000[m
[1m--- a/database.js[m
[1m+++ b/database.js[m
[36m@@@ -1,138 -1,109 +1,250 @@@[m
[32m++<<<<<<< HEAD[m
[32m +const { Pool } = require('pg');[m
[32m +require('dotenv').config();[m
[32m +[m
[32m +class Database {[m
[32m +    constructor() {[m
[32m +        this.pool = new Pool({[m
[32m +            connectionString: process.env.DATABASE_URL,[m
[32m +            ssl: {[m
[32m +                rejectUnauthorized: false[m
[32m +            },[m
[32m +            max: 20,[m
[32m +            idleTimeoutMillis: 30000,[m
[32m +            connectionTimeoutMillis: 10000,[m
[32m +            maxUses: 7500,[m
[32m +        });[m
[32m +[m
[32m +        this.setupEventListeners();[m
[32m +    }[m
[32m +[m
[32m +    setupEventListeners() {[m
[32m +        this.pool.on('connect', () => {[m
[32m +            console.log('âœ… Nueva conexiÃ³n establecida con Neon PostgreSQL');[m
[32m +        });[m
[32m +[m
[32m +        this.pool.on('error', (err) => {[m
[32m +            console.error('âŒ Error en el pool de conexiones:', err.message);[m
[32m +        });[m
[32m +[m
[32m +        this.pool.on('acquire', () => {[m
[32m +            console.log('ğŸ”— Cliente adquirido del pool');[m
[32m +        });[m
[32m +[m
[32m +        this.pool.on('remove', () => {[m
[32m +            console.log('ğŸ”Œ Cliente removido del pool');[m
[32m +        });[m
[32m +    }[m
[32m +[m
[32m +    async testConnection() {[m
[32m +        let client;[m
[32m +        try {[m
[32m +            client = await this.pool.connect();[m
[32m +            console.log('ğŸ”Œ Conectado a Neon PostgreSQL');[m
[32m +            [m
[32m +            const versionResult = await client.query('SELECT version()');[m
[32m +            console.log('ğŸ˜ PostgreSQL:', versionResult.rows[0].version.split(',')[0]);[m
[32m +            [m
[32m +            const timeResult = await client.query('SELECT NOW() as server_time');[m
[32m +            console.log('ğŸ“… Hora del servidor:', timeResult.rows[0].server_time);[m
[32m +            [m
[32m +            return true;[m
[32m +        } catch (error) {[m
[32m +            console.error('âŒ Error de conexiÃ³n a la base de datos:', error.message);[m
[32m +            [m
[32m +            if (error.code === '28P01') {[m
[32m +                console.error('ğŸ” Error de autenticaciÃ³n - Verifica usuario/contraseÃ±a');[m
[32m +            } else if (error.code === 'ECONNREFUSED') {[m
[32m +                console.error('ğŸŒ Error de conexiÃ³n - Verifica la URL y el host');[m
[32m +            } else if (error.code === 'ENOTFOUND') {[m
[32m +                console.error('ğŸ” Host no encontrado - Verifica la URL de conexiÃ³n');[m
[32m +            }[m
[32m +            [m
[32m +            return false;[m
[32m +        } finally {[m
[32m +            if (client) client.release();[m
[32m +        }[m
[32m +    }[m
[32m +[m
[32m +    async query(text, params = []) {[m
[32m +        const start = Date.now();[m
[32m +        let client;[m
[32m +        [m
[32m +        try {[m
[32m +            client = await this.pool.connect();[m
[32m +            const result = await client.query(text, params);[m
[32m +            const duration = Date.now() - start;[m
[32m +            [m
[32m +            if (duration > 100 || process.env.NODE_ENV === 'development') {[m
[32m +                console.log(`ğŸ“Š Query ejecutada en ${duration}ms:`, [m
[32m +                    text.length > 100 ? text.substring(0, 100) + '...' : text);[m
[32m +            }[m
[32m +            [m
[32m +            return result;[m
[32m +        } catch (error) {[m
[32m +            const duration = Date.now() - start;[m
[32m +            console.error(`âŒ Error en query (${duration}ms):`, {[m
[32m +                query: text.length > 200 ? text.substring(0, 200) + '...' : text,[m
[32m +                params: params.length > 0 ? params : 'Sin parÃ¡metros',[m
[32m +                error: error.message,[m
[32m +                code: error.code[m
[32m +            });[m
[32m +            [m
[32m +            throw error;[m
[32m +        } finally {[m
[32m +            if (client) client.release();[m
[32m +        }[m
[32m +    }[m
[32m +[m
[32m +    async transaction(callback) {[m
[32m +        const client = await this.pool.connect();[m
[32m +        [m
[32m +        try {[m
[32m +            await client.query('BEGIN');[m
[32m +            const result = await callback(client);[m
[32m +            await client.query('COMMIT');[m
[32m +            return result;[m
[32m +        } catch (error) {[m
[32m +            await client.query('ROLLBACK');[m
[32m +            console.error('âŒ Error en transacciÃ³n:', error.message);[m
[32m +            throw error;[m
[32m +        } finally {[m
[32m +            client.release();[m
[32m +        }[m
[32m +    }[m
[32m +[m
[32m +    getPoolStats() {[m
[32m +        return {[m
[32m +            totalCount: this.pool.totalCount,[m
[32m +            idleCount: this.pool.idleCount,[m
[32m +            waitingCount: this.pool.waitingCount[m
[32m +        };[m
[32m +    }[m
[32m +[m
[32m +    async close() {[m
[32m +        await this.pool.end();[m
[32m +        console.log('ğŸ”Œ ConexiÃ³n a la base de datos cerrada');[m
[32m +    }[m
[32m +}[m
[32m +[m
[32m +// Crear instancia Ãºnica[m
[32m +const database = new Database();[m
[32m +[m
[32m +// Probar conexiÃ³n al iniciar[m
[32m +(async () => {[m
[32m +    console.log('ğŸ”„ Inicializando conexiÃ³n a la base de datos...');[m
[32m +    await database.testConnection();[m
[32m +})();[m
[32m +[m
[31m- module.exports = database;[m
[32m++module.exports = database;[m
[32m++=======[m
[32m+ // database.js - ConexiÃ³n a Neon PostgreSQL optimizada para producciÃ³n[m
[32m+ const { Pool } = require('pg');[m
[32m+ require('dotenv').config();[m
[32m+ [m
[32m+ // ConfiguraciÃ³n de conexiÃ³n a Neon desde variables de entorno[m
[32m+ const pool = new Pool({[m
[32m+     connectionString: process.env.DATABASE_URL,[m
[32m+     ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,[m
[32m+     max: 20, // mÃ¡ximo de conexiones en el pool[m
[32m+     idleTimeoutMillis: 30000,[m
[32m+     connectionTimeoutMillis: 5000,[m
[32m+     maxUses: 7500, // reconectar despuÃ©s de 7500 consultas[m
[32m+ });[m
[32m+ [m
[32m+ // Manejo de eventos del pool[m
[32m+ pool.on('connect', (client) => {[m
[32m+     console.log('âœ… Nueva conexiÃ³n establecida con la base de datos');[m
[32m+ });[m
[32m+ [m
[32m+ pool.on('error', (err, client) => {[m
[32m+     console.error('âŒ Error en el pool de conexiones:', err);[m
[32m+ });[m
[32m+ [m
[32m+ pool.on('remove', (client) => {[m
[32m+     console.log('ğŸ”Œ Cliente removido del pool');[m
[32m+ });[m
[32m+ [m
[32m+ // FunciÃ³n para probar la conexiÃ³n[m
[32m+ async function testConnection() {[m
[32m+     try {[m
[32m+         const client = await pool.connect();[m
[32m+         const result = await client.query('SELECT version(), NOW() as server_time');[m
[32m+         console.log('ğŸ”Œ ConexiÃ³n a PostgreSQL exitosa:');[m
[32m+         console.log('   ğŸ“… Hora del servidor:', result.rows[0].server_time);[m
[32m+         console.log('   ğŸ˜ VersiÃ³n:', result.rows[0].version.split(',')[0]);[m
[32m+         client.release();[m
[32m+         return true;[m
[32m+     } catch (error) {[m
[32m+         console.error('âŒ Error probando conexiÃ³n a la base de datos:', error.message);[m
[32m+         return false;[m
[32m+     }[m
[32m+ }[m
[32m+ async function query(text, params) {[m
[32m+     const start = Date.now();[m
[32m+     try {[m
[32m+         console.log('ğŸ” [DB] Ejecutando query:');[m
[32m+         console.log('   - SQL:', text.substring(0, 200));[m
[32m+         console.log('   - ParÃ¡metros:', params);[m
[32m+         console.log('   - Tipos de parÃ¡metros:', params.map(p => typeof p));[m
[32m+         [m
[32m+         const result = await pool.query(text, params);[m
[32m+         const duration = Date.now() - start;[m
[32m+         console.log(`âœ… [DB] Query exitosa (${duration}ms)`);[m
[32m+         return result;[m
[32m+     } catch (error) {[m
[32m+         console.error('âŒ [DB] Error en query:');[m
[32m+         console.error('   - Mensaje:', error.message);[m
[32m+         console.error('   - CÃ³digo:', error.code);[m
[32m+         console.error('   - Detalle:', error.detail);[m
[32m+         console.error('   - ParÃ¡metros enviados:', params);[m
[32m+         throw error;[m
[32m+     }[m
[32m+ }[m
[32m+ // FunciÃ³n de consulta mejorada con manejo de errores[m
[32m+ async function query(text, params) {[m
[32m+     const start = Date.now();[m
[32m+     try {[m
[32m+         const result = await pool.query(text, params);[m
[32m+         const duration = Date.now() - start;[m
[32m+         console.log(`ğŸ“Š Query ejecutada en ${duration}ms:`, text.substring(0, 100) + '...');[m
[32m+         return result;[m
[32m+     } catch (error) {[m
[32m+         console.error('âŒ Error en query:', {[m
[32m+             query: text,[m
[32m+             params: params,[m
[32m+             error: error.message[m
[32m+         });[m
[32m+         throw error;[m
[32m+     }[m
[32m+ }[m
[32m+ [m
[32m+ // FunciÃ³n para obtener un cliente del pool (para transacciones)[m
[32m+ async function getClient() {[m
[32m+     const client = await pool.connect();[m
[32m+     const query = client.query;[m
[32m+     const release = client.release;[m
[32m+     [m
[32m+     // Establecer un timeout para el cliente[m
[32m+     const timeout = setTimeout(() => {[m
[32m+         console.error('â° Timeout del cliente de base de datos');[m
[32m+         client.release();[m
[32m+     }, 10000);[m
[32m+     [m
[32m+     client.release = () => {[m
[32m+         clearTimeout(timeout);[m
[32m+         client.query = query;[m
[32m+         client.release = release;[m
[32m+         return release.apply(client);[m
[32m+     };[m
[32m+     [m
[32m+     return client;[m
[32m+ }[m
[32m+ [m
[32m+ module.exports = {[m
[32m+     query,[m
[32m+     pool,[m
[32m+     getClient,[m
[32m+     testConnection[m
[32m+ };[m
[32m++>>>>>>> ddbc4150425c6b5666efb963cfd36bd9823a6d11[m
